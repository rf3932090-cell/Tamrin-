name: CI/CD Pipeline with SSH (password)

on:
  push:
    branches:
      - main

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Simulate build
        run: |
          echo "Building (simulated)..."

  test:
    name: Test
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Simulate tests
        run: |
          echo "Running tests (simulated)..."

  deploy:
    name: Deploy via SCP/SSH (uses password)
    runs-on: ubuntu-latest
    needs: test
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # copy files from repo to remote server (adjust source and target as needed)
      - name: Copy project files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASS }}
          port: 22
          source: "tamrin/templates/*"        # ← مسیر محلی در ریپو؛ اگر می‌خواهی tamrin/templates/* بفرستی، عوضش کن
          target: "/var/www/RAAZIEH"   # ← مسیر مقصد روی سرور — آن را با مسیر صحیح جایگزین کن

      # optional: run commands on remote (مثلاً برای restart یا permission)
      - name: Run remote commands (optional)
        uses: appleboy/ssh-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_IP }}
          username: ${{ secrets.SERVER_USER }}
          password: ${{ secrets.SERVER_PASS }}
          port: 22
          script: |
            echo "Listing deployed files in /var/www/html:"
            ls -la /var/www/RAAZIEH
            # اگر لازم است سرویس وب را ری‌استارت کن (در صورت داشتن مجوز sudo):
            # echo "${{ secrets.SERVER_PASS }}" | sudo -S systemctl restart nginx || true
        
